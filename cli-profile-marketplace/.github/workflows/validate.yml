name: Validate Profiles

on:
  push:
    branches: [main]
    paths:
      - 'profiles/**'
      - 'index.json'
  pull_request:
    branches: [main]
    paths:
      - 'profiles/**'
      - 'index.json'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Validate index.json
        run: |
          echo "Validating index.json..."
          node -e "JSON.parse(require('fs').readFileSync('index.json'))"
          echo "✓ index.json is valid JSON"
          
      - name: Validate profile metadata
        run: |
          echo "Validating profile metadata..."
          
          for profile_dir in profiles/*/*; do
            if [ -d "$profile_dir" ]; then
              profile_json="$profile_dir/profile.json"
              snapshot_zip="$profile_dir/snapshot.zip"
              
              if [ ! -f "$profile_json" ]; then
                echo "✗ Missing profile.json in $profile_dir"
                exit 1
              fi
              
              if [ ! -f "$snapshot_zip" ]; then
                echo "✗ Missing snapshot.zip in $profile_dir"
                exit 1
              fi
              
              # Validate JSON
              node -e "JSON.parse(require('fs').readFileSync('$profile_json'))"
              
              # Check required fields
              node -e "
                const p = JSON.parse(require('fs').readFileSync('$profile_json'));
                const required = ['name', 'version', 'description', 'author'];
                for (const field of required) {
                  if (!p[field]) {
                    console.error('Missing required field: ' + field);
                    process.exit(1);
                  }
                }
              "
              
              echo "✓ $profile_dir"
            fi
          done
          
          echo "✓ All profiles validated"

      - name: Check index completeness
        run: |
          echo "Checking index completeness..."
          
          node -e "
            const fs = require('fs');
            const path = require('path');
            const index = JSON.parse(fs.readFileSync('index.json'));
            
            const indexProfiles = new Set(
              index.profiles.map(p => p.author + '/' + p.name)
            );
            
            const profileDirs = fs.readdirSync('profiles', { withFileTypes: true })
              .filter(d => d.isDirectory())
              .flatMap(author => {
                const authorPath = path.join('profiles', author.name);
                return fs.readdirSync(authorPath, { withFileTypes: true })
                  .filter(d => d.isDirectory())
                  .map(profile => author.name + '/' + profile.name);
              });
            
            for (const dir of profileDirs) {
              if (!indexProfiles.has(dir)) {
                console.warn('Warning: Profile not in index:', dir);
              }
            }
            
            console.log('✓ Index check complete');
          "
